<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Tự chọn từ vựng học tập</title>
    
    <!-- CSRF Token -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
        <link th:href="@{/css/global.css}" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        .learning-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .learning-header .breadcrumb {
            background: transparent;
            margin-bottom: 0;
            padding: 0;
        }

        .learning-header .breadcrumb-item a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .learning-header .breadcrumb-item a:hover {
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .learning-header .breadcrumb-item.active {
            color: rgba(255, 255, 255, 0.95);
        }

        .learning-header .breadcrumb-item + .breadcrumb-item::before {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .vocab-item {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 0.5rem;
            cursor: pointer;
            position: relative;
        }
        
        .vocab-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .vocab-item.selected {
            border-left: 4px solid #007bff;
            background: rgba(0,123,255,0.05);
        }
        
        .vocab-item.selected .selection-checkbox {
            background: #007bff;
            color: white;
        }
        
        .selection-checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            border: 2px solid #dee2e6;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            transition: all 0.3s ease;
        }
        
        .filter-panel {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .list-checkbox-item {
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .list-checkbox-item:hover {
            background-color: #f8f9fa;
            border-color: #007bff;
        }
        
        .list-checkbox-item input[type="checkbox"]:checked {
            background-color: #007bff;
            border-color: #007bff;
        }
        
        .selected-panel {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
        }
        
        .vocab-word {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }
        
        .vocab-ipa {
            color: #3498db;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        .vocab-meaning {
            color: #27ae60;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .vocab-pos {
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .level-badge {
            font-size: 0.75rem;
        }
        
        .progress-indicator {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-bar-custom {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .progress-new { background: #6c757d; }
        .progress-learning { background: #ffc107; }
        .progress-mastered { background: #28a745; }
        
        .start-learning-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .start-learning-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .start-learning-btn:disabled {
            background: #6c757d;
            box-shadow: none;
        }
        
        .bulk-actions {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box .bi-search {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .search-box input {
            padding-left: 45px;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }

        /* Pagination Styles */
        .pagination {
            margin: 2rem 0;
        }

        .pagination .page-item.active .page-link {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .pagination .page-link {
            color: #667eea;
            border: 2px solid #e9ecef;
            border-radius: 0.5rem;
            margin: 0 0.25rem;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .pagination .page-link:hover {
            background-color: #f8f9fa;
            border-color: #667eea;
            color: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }

        .pagination .page-item.disabled .page-link {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            color: #6c757d;
        }

        .pagination .page-item:first-child .page-link,
        .pagination .page-item:last-child .page-link {
            font-weight: bold;
            padding: 0.5rem 1.2rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="learning-header">
        <div class="container">
            <!-- Breadcrumb Navigation -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a th:href="@{/vocabulary/dictionaries}">Từ điển</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a th:href="@{/vocabulary/dictionary/{id}(id=${dictionary.dictionaryId})}" th:text="${dictionary.name}">Dictionary</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Tự chọn từ vựng</li>
                </ol>
            </nav>
            
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-1">
                        <i class="bi bi-hand-index-thumb me-2"></i>
                        <span th:text="${dictionary.name}">Dictionary Name</span>
                    </h1>
                    <p class="mb-0 opacity-75">Tự chọn từ vựng để học tập</p>
                </div>
                <div class="col-md-4 text-end">
                    <a th:href="@{/vocabulary/dictionary/{id}(id=${dictionary.dictionaryId})}" class="btn btn-outline-light">
                        <i class="bi bi-arrow-left me-1"></i> Quay lại từ điển
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <!-- Main Content -->
            <div class="col-md-8">
                <!-- Filter Panel -->
                <div class="filter-panel">
                    <div class="row align-items-end">
                        <div class="col-md-4">
                            <label class="form-label small">Tìm kiếm từ vựng</label>
                            <div class="search-box">
                                <i class="bi bi-search"></i>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="Nhập từ cần tìm..." onkeyup="filterVocabulary()">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Độ khó</label>
                            <select class="form-select form-select-sm" id="levelFilter" onchange="filterVocabulary()">
                                <option value="">Tất cả</option>
                                <option value="BEGINNER">Beginner</option>
                                <option value="INTERMEDIATE">Intermediate</option>
                                <option value="ADVANCED">Advanced</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Trạng thái học tập</label>
                            <select class="form-select form-select-sm" id="statusFilter" onchange="filterVocabulary()">
                                <option value="">Tất cả</option>
                                <option value="NEW">Chưa học</option>
                                <option value="LEARNING">Đang học</option>
                                <option value="MASTERED">Đã thành thạo</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearAllFilters()" style="margin-top: 1.5rem;">
                                <i class="bi bi-x-circle"></i> Xóa bộ lọc
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="bulk-actions">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllCheckbox" 
                                       onchange="toggleSelectAll()">
                                <label class="form-check-label" for="selectAllCheckbox">
                                    Chọn tất cả (<span id="totalVocabCount">0</span>)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="selectByLevel('BEGINNER')">
                                    Beginner
                                </button>
                                <button class="btn btn-outline-warning" onclick="selectByLevel('INTERMEDIATE')">
                                    Intermediate
                                </button>
                                <button class="btn btn-outline-danger" onclick="selectByLevel('ADVANCED')">
                                    Advanced
                                </button>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="clearAllSelections()">
                                <i class="bi bi-x-circle"></i> Bỏ chọn
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Vocabulary List -->
                <div id="vocabularyList">
                    <!-- Vocabulary Items with Real Progress -->
                    <div class="vocab-item card mb-2" th:each="vocabDTO : ${vocabularies}" 
                         th:attr="data-vocab-id=${vocabDTO.vocab.vocabId}, data-level=${vocabDTO.vocab.level.name()}, data-status=${vocabDTO.status}"
                         onclick="toggleVocabSelection(this)">
                        <div class="selection-checkbox">
                            <i class="bi bi-check" style="display: none;"></i>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div class="vocab-word" th:text="${vocabDTO.vocab.word}">word</div>
                                    <div class="vocab-ipa" th:if="${vocabDTO.vocab.ipa}" th:text="${vocabDTO.vocab.ipa}">/ipa/</div>
                                    <div class="d-flex gap-2 mt-2">
                                        <span class="vocab-pos" th:text="${vocabDTO.vocab.pos}">pos</span>
                                        <span class="badge level-badge" 
                                              th:class="'badge level-badge bg-' + (${vocabDTO.vocab.level.name() == 'BEGINNER'} ? 'success' : 
                                                                                 (${vocabDTO.vocab.level.name() == 'INTERMEDIATE'} ? 'warning' : 'danger'))"
                                              th:text="${vocabDTO.vocab.level.name()}">LEVEL</span>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="vocab-meaning">
                                        <strong>Nghĩa:</strong> <span th:text="${vocabDTO.vocab.senses[0].meaningVi}">meaning</span>
                                        <div th:if="${vocabDTO.vocab.senses[0].definition}" class="small text-muted mt-1" th:text="${vocabDTO.vocab.senses[0].definition}">definition</div>
                                    </div>
                                    <div class="progress-indicator">
                                        <div class="progress-bar-custom" 
                                             th:classappend="${vocabDTO.proficiency == 0 ? 'progress-new' : (vocabDTO.proficiency < 50 ? 'progress-learning' : 'progress-mastered')}"
                                             th:style="'width: ' + ${vocabDTO.proficiency} + '%'">
                                        </div>
                                    </div>
                                    <small class="text-muted mt-1" 
                                           th:text="${vocabDTO.proficiency == 0 ? 'Chưa học' : (vocabDTO.proficiency < 50 ? 'Đang học (' + vocabDTO.proficiency + '%)' : 'Đã thành thạo (' + vocabDTO.proficiency + '%)')}">
                                        Chưa học
                                    </small>
                                </div>
                                <div class="col-md-1 text-center">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="event.stopPropagation(); previewVocab(this)"
                                            title="Xem chi tiết">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- No vocabulary message -->
                    <div th:if="${vocabularies == null or vocabularies.isEmpty()}" class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="bi bi-info-circle me-2"></i>
                            Không tìm thấy từ vựng nào trong từ điển này.
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <div th:if="${totalPages > 1}" class="row mt-4">
                    <div class="col-12">
                        <nav aria-label="Vocabulary pagination">
                            <ul class="pagination justify-content-center">
                                <!-- Previous Button -->
                                <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled' : ''">
                                    <a class="page-link" 
                                       th:href="@{/learn/dictionary/{id}/custom(id=${dictionary.dictionaryId}, page=${currentPage - 1}, search=${search}, level=${level})}"
                                       aria-label="Previous">
                                        <span aria-hidden="true">&laquo; Trước</span>
                                    </a>
                                </li>

                                <!-- First Page -->
                                <li th:if="${currentPage > 3}" class="page-item">
                                    <a class="page-link" 
                                       th:href="@{/learn/dictionary/{id}/custom(id=${dictionary.dictionaryId}, page=1, search=${search}, level=${level})}">1</a>
                                </li>
                                <li th:if="${currentPage > 3}" class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>

                                <!-- Page Numbers (show 5 pages around current) -->
                                <li th:each="i : ${#numbers.sequence(currentPage - 2, currentPage + 2)}"
                                    th:if="${i > 0 && i <= totalPages}"
                                    class="page-item"
                                    th:classappend="${i == currentPage} ? 'active' : ''">
                                    <a class="page-link" 
                                       th:href="@{/learn/dictionary/{id}/custom(id=${dictionary.dictionaryId}, page=${i}, search=${search}, level=${level})}"
                                       th:text="${i}">1</a>
                                </li>

                                <!-- Last Page -->
                                <li th:if="${currentPage < totalPages - 2}" class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                <li th:if="${currentPage < totalPages - 2}" class="page-item">
                                    <a class="page-link" 
                                       th:href="@{/learn/dictionary/{id}/custom(id=${dictionary.dictionaryId}, page=${totalPages}, search=${search}, level=${level})}"
                                       th:text="${totalPages}">5</a>
                                </li>

                                <!-- Next Button -->
                                <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled' : ''">
                                    <a class="page-link" 
                                       th:href="@{/learn/dictionary/{id}/custom(id=${dictionary.dictionaryId}, page=${currentPage + 1}, search=${search}, level=${level})}"
                                       aria-label="Next">
                                        <span aria-hidden="true">Tiếp &raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                        
                        <!-- Page Info -->
                        <div class="text-center text-muted mb-3">
                            <small>
                                Trang <strong th:text="${currentPage}">1</strong> / <strong th:text="${totalPages}">5</strong>
                                <span th:if="${vocabularies != null && !vocabularies.isEmpty()}">
                                    - Hiển thị <strong th:text="${vocabularies.size()}">20</strong> từ
                                </span>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="empty-state d-none" id="emptyState">
                    <i class="bi bi-search display-1 text-muted mb-3"></i>
                    <h5>Không tìm thấy từ vựng</h5>
                    <p class="text-muted">Thử thay đổi bộ lọc hoặc từ khóa tìm kiếm</p>
                </div>
            </div>

            <!-- Selected Panel -->
            <div class="col-md-4">
                <div class="selected-panel">
                    <h6 class="mb-3">
                        <i class="bi bi-heart text-danger"></i> 
                        Từ đã chọn 
                        <span class="badge bg-primary ms-2" id="selectedCount">0</span>
                    </h6>
                    
                    <div id="selectedVocabList" class="mb-3" style="max-height: 200px; overflow-y: auto;">
                        <p class="text-muted text-center">Chưa chọn từ nào</p>
                    </div>
                    
                    <!-- Summary -->
                    <div class="border-top pt-3">
                        <div class="row text-center mb-3">
                            <div class="col-4">
                                <div class="text-secondary fw-bold h6" id="newWordsCount">0</div>
                                <small class="text-muted">Chưa học</small>
                            </div>
                            <div class="col-4">
                                <div class="text-warning fw-bold h6" id="learningWordsCount">0</div>
                                <small class="text-muted">Đang học</small>
                            </div>
                            <div class="col-4">
                                <div class="text-success fw-bold h6" id="masteredWordsCount">0</div>
                                <small class="text-muted">Thành thạo</small>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted">Thời gian dự kiến:</small>
                            <small class="fw-bold" id="estimatedTime">0 phút</small>
                        </div>
                    </div>
                    
                    <!-- Start Learning Button -->
                    <button class="btn start-learning-btn" id="startLearningBtn" disabled onclick="startCustomLearning()">
                        <i class="bi bi-play-circle me-2"></i>Bắt đầu học
                    </button>
                    
                    <!-- Save to List Button -->
                    <button class="btn btn-outline-primary btn-sm w-100 mt-2" id="saveToListBtn" disabled onclick="showSaveToListModal()">
                        <i class="bi bi-folder-plus"></i> Lưu vào danh sách
                    </button>
                </div>
            </div>
        </div>

        <!-- Vocab Preview Modal -->
        <div class="modal fade" id="vocabPreviewModal" tabindex="-1" aria-labelledby="vocabPreviewModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="vocabPreviewModalLabel">Chi tiết từ vựng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="vocabPreviewContent">
                        <!-- Vocab details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Learning Confirmation Modal -->
        <div class="modal fade" id="learningModal" tabindex="-1" aria-labelledby="learningModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="learningModalLabel">
                            <i class="bi bi-hand-index-thumb"></i> Xác nhận session tự chọn
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Bạn đã chọn <span id="modalSelectedCount">0</span> từ vựng để học:</strong></p>
                        <div class="mb-3" style="max-height: 150px; overflow-y: auto;">
                            <div id="modalSelectedList"></div>
                        </div>
                        
                        <div class="row">
                            <div class="col-6">
                                <p><strong>Từ điển:</strong> <span th:text="${dictionary.name}">Dictionary Name</span></p>
                                <p><strong>Chưa học:</strong> <span id="modalNewCount" class="text-secondary">0</span> từ</p>
                            </div>
                            <div class="col-6">
                                <p><strong>Thời gian dự kiến:</strong> <span id="modalEstimatedTime">0</span> phút</p>
                                <p><strong>Đang học/Thành thạo:</strong> <span id="modalProgressCount" class="text-warning">0</span>/<span id="modalMasteredCount" class="text-success">0</span></p>
                            </div>
                        </div>
                        
                        <div class="alert alert-success">
                            <i class="bi bi-lightbulb"></i>
                            <strong>Tuyệt vời!</strong> Việc tự chọn từ vựng giúp bạn tập trung vào những từ cần thiết nhất.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="button" class="btn btn-success" onclick="confirmStartCustomLearning()">
                            <i class="bi bi-rocket"></i> Bắt đầu ngay
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Save to List Modal -->
        <div class="modal fade" id="saveToListModal" tabindex="-1" aria-labelledby="saveToListModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="saveToListModalLabel">
                            <i class="bi bi-folder-plus"></i> Lưu từ vựng vào danh sách
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Bạn đã chọn <span id="saveModalSelectedCount">0</span> từ vựng</strong></p>
                        
                        <div class="mb-3">
                            <label class="form-label">Chọn danh sách:</label>
                            <div id="userListsContainer" style="max-height: 300px; overflow-y: auto;">
                                <!-- Danh sách sẽ được load bằng JS -->
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <small><strong>Lưu ý:</strong> Các từ vựng đã chọn sẽ được thêm vào danh sách bạn chọn.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="button" class="btn btn-primary" onclick="confirmSaveToList()" id="confirmSaveBtn" disabled>
                            <i class="bi bi-check-circle"></i> Xác nhận lưu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script th:inline="javascript">
        // Global variables
        const dictionaryId = /*[[${dictionary.dictionaryId}]]*/ 1;
        const currentUserId = /*[[${currentUserId}]]*/ 'admin';
        const userLists = /*[[${userLists}]]*/ [];
        let selectedVocabs = new Map();
        let allVocabs = [];
        
        /**
         * Initialize page
         */
        document.addEventListener('DOMContentLoaded', function() {
            updateVocabCount();
            
            // Smooth scroll to vocabulary section when navigating between pages
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('page')) {
                setTimeout(() => {
                    const vocabList = document.getElementById('vocabularyList');
                    if (vocabList) {
                        vocabList.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        });
        
        /**
         * Toggle vocabulary selection
         */
        function toggleVocabSelection(element) {
            const vocabId = parseInt(element.getAttribute('data-vocab-id'));
            const checkbox = element.querySelector('.selection-checkbox i');
            const word = element.querySelector('.vocab-word').textContent;
            const level = element.getAttribute('data-level');
            const status = element.getAttribute('data-status');
            
            if (selectedVocabs.has(vocabId)) {
                selectedVocabs.delete(vocabId);
                element.classList.remove('selected');
                checkbox.style.display = 'none';
            } else {
                selectedVocabs.set(vocabId, { word, level, status });
                element.classList.add('selected');
                checkbox.style.display = 'block';
            }
            
            updateSelectedPanel();
        }
        
        /**
         * Update selected vocabulary panel
         */
        function updateSelectedPanel() {
            const selectedCount = document.getElementById('selectedCount');
            const selectedList = document.getElementById('selectedVocabList');
            const startBtn = document.getElementById('startLearningBtn');
            const newCount = document.getElementById('newWordsCount');
            const learningCount = document.getElementById('learningWordsCount');
            const masteredCount = document.getElementById('masteredWordsCount');
            const estimatedTime = document.getElementById('estimatedTime');
            
            selectedCount.textContent = selectedVocabs.size;
            
            if (selectedVocabs.size === 0) {
                selectedList.innerHTML = '<p class="text-muted text-center">Chưa chọn từ nào</p>';
                startBtn.disabled = true;
                newCount.textContent = '0';
                learningCount.textContent = '0';
                masteredCount.textContent = '0';
                estimatedTime.textContent = '0 phút';
            } else {
                let html = '';
                let newWords = 0, learningWords = 0, reviewingWords = 0, masteredWords = 0;
                
                selectedVocabs.forEach((vocab, id) => {
                    html += `<div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small">${vocab.word}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeVocab(${id})" title="Xóa">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>`;
                    
                    // Count by actual status from backend
                    if (vocab.status === 'NEW') newWords++;
                    else if (vocab.status === 'LEARNING') learningWords++;
                    else if (vocab.status === 'REVIEWING') reviewingWords++;
                    else if (vocab.status === 'MASTERED') masteredWords++;
                });
                
                selectedList.innerHTML = html;
                startBtn.disabled = false;
                newCount.textContent = newWords;
                learningCount.textContent = (learningWords + reviewingWords); // Combined
                masteredCount.textContent = masteredWords;
                
                // Fixed time: 1 từ = 1 phút
                const time = selectedVocabs.size === 1 ? '1 phút' : `1-${selectedVocabs.size} phút`;
                estimatedTime.textContent = time;
            }
        }
        
        /**
         * Remove vocabulary from selection
         */
        function removeVocab(vocabId) {
            const element = document.querySelector(`[data-vocab-id="${vocabId}"]`);
            if (element) {
                element.classList.remove('selected');
                element.querySelector('.selection-checkbox i').style.display = 'none';
            }
            selectedVocabs.delete(vocabId);
            updateSelectedPanel();
        }
        
        /**
         * Toggle select all
         */
        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAllCheckbox');
            const visibleVocabs = document.querySelectorAll('.vocab-item:not(.d-none)');
            
            if (checkbox.checked) {
                visibleVocabs.forEach(element => {
                    const vocabId = parseInt(element.getAttribute('data-vocab-id'));
                    if (!selectedVocabs.has(vocabId)) {
                        toggleVocabSelection(element);
                    }
                });
            } else {
                clearAllSelections();
            }
        }
        
        /**
         * Select by level
         */
        function selectByLevel(level) {
            document.querySelectorAll(`[data-level="${level}"]:not(.d-none)`).forEach(element => {
                const vocabId = parseInt(element.getAttribute('data-vocab-id'));
                if (!selectedVocabs.has(vocabId)) {
                    toggleVocabSelection(element);
                }
            });
        }
        
        /**
         * Clear all selections
         */
        function clearAllSelections() {
            document.querySelectorAll('.vocab-item.selected').forEach(element => {
                toggleVocabSelection(element);
            });
            document.getElementById('selectAllCheckbox').checked = false;
        }
        
        /**
         * Filter vocabulary
         */
        function filterVocabulary() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const level = document.getElementById('levelFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            let visibleCount = 0;
            document.querySelectorAll('.vocab-item').forEach(element => {
                const word = element.querySelector('.vocab-word').textContent.toLowerCase();
                const vocabLevel = element.getAttribute('data-level');
                const vocabStatus = element.getAttribute('data-status');
                
                const matchSearch = !search || word.includes(search);
                const matchLevel = !level || vocabLevel === level;
                const matchStatus = !status || vocabStatus === status;
                
                if (matchSearch && matchLevel && matchStatus) {
                    element.classList.remove('d-none');
                    visibleCount++;
                } else {
                    element.classList.add('d-none');
                }
            });
            
            document.getElementById('totalVocabCount').textContent = visibleCount;
            
            // Show/hide empty state
            const emptyState = document.getElementById('emptyState');
            if (visibleCount === 0) {
                emptyState.classList.remove('d-none');
            } else {
                emptyState.classList.add('d-none');
            }
        }
        
        /**
         * Update vocabulary count
         */
        function updateVocabCount() {
            const totalCount = document.querySelectorAll('.vocab-item').length;
            document.getElementById('totalVocabCount').textContent = totalCount;
        }
        
        /**
         * Clear all filters
         */
        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('levelFilter').value = '';
            document.getElementById('statusFilter').value = '';
            filterVocabulary();
        }
        
        /**
         * Preview vocabulary
         */
        function previewVocab(button) {
            // Mock preview data
            const vocabId = button.closest('.vocab-item').getAttribute('data-vocab-id');
            const word = button.closest('.vocab-item').querySelector('.vocab-word').textContent;
            
            document.getElementById('vocabPreviewContent').innerHTML = `
                <div class="text-center mb-3">
                    <h4>${word}</h4>
                    <div class="text-muted">/wɜːd/</div>
                </div>
                <div class="mb-3">
                    <strong>Meanings:</strong>
                    <ul class="list-unstyled ms-3">
                        <li>• <strong>noun:</strong> từ, từ ngữ, lời nói</li>
                        <li>• <strong>verb:</strong> diễn đạt, phát biểu</li>
                    </ul>
                </div>
                <div class="mb-3">
                    <strong>Examples:</strong>
                    <ul class="list-unstyled ms-3">
                        <li>• "Can you explain this <strong>word</strong>?"</li>
                        <li>• "He didn't say a <strong>word</strong>."</li>
                    </ul>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('vocabPreviewModal'));
            modal.show();
        }
        
        /**
         * Start custom learning
         */
        function startCustomLearning() {
            if (selectedVocabs.size === 0) return;
            
            // Calculate statistics
            let newWords = 0, learningWords = 0, masteredWords = 0;
            selectedVocabs.forEach((vocab, id) => {
                if (vocab.status === 'NEW') newWords++;
                else if (vocab.status === 'LEARNING' || vocab.status === 'REVIEWING') learningWords++;
                else if (vocab.status === 'MASTERED') masteredWords++;
            });
            
            // Update modal content
            document.getElementById('modalSelectedCount').textContent = selectedVocabs.size;
            document.getElementById('modalEstimatedTime').textContent = 
                selectedVocabs.size === 1 ? '1' : `1-${selectedVocabs.size}`;
            document.getElementById('modalNewCount').textContent = newWords;
            document.getElementById('modalProgressCount').textContent = learningWords;
            document.getElementById('modalMasteredCount').textContent = masteredWords;
            
            let modalList = '';
            let counter = 1;
            selectedVocabs.forEach((vocab, id) => {
                modalList += `<span class="badge bg-light text-dark me-1 mb-1">${counter++}. ${vocab.word}</span>`;
            });
            document.getElementById('modalSelectedList').innerHTML = modalList;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('learningModal'));
            modal.show();
        }
        
        /**
         * Confirm start custom learning
         */
        function confirmStartCustomLearning() {
            // Validate dictionaryId
            if (!dictionaryId || dictionaryId === 'null' || dictionaryId === null) {
                alert('Lỗi: Không tìm thấy ID từ điển. Vui lòng tải lại trang.');
                return;
            }
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            const formData = new FormData();
            formData.append('dictionaryId', dictionaryId);
            formData.append('learningMode', 'custom');
            formData.append('sessionSize', selectedVocabs.size); // Use actual selected count
            
            // Add selected vocab IDs
            selectedVocabs.forEach((vocab, id) => {
                formData.append('selectedVocabIds', id);
            });
            
            // Submit to start session
            const headers = {};
            headers[csrfHeader] = csrfToken;
            
            fetch('/learn/session/start', {
                method: 'POST',
                headers: headers,
                body: formData,
                redirect: 'follow'
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }

                if (response.ok) {
                    const locationHeader = response.headers.get('X-Redirect-Url');
                    if (locationHeader) {
                        window.location.href = locationHeader;
                        return;
                    }
                }

                throw new Error('Failed to start session');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi bắt đầu session học tập. Vui lòng thử lại!');
            });
        }
        
        /**
         * Show save to list modal
         */
        function showSaveToListModal() {
            if (selectedVocabs.size === 0) {
                alert('Vui lòng chọn ít nhất một từ vựng để lưu!');
                return;
            }
            
            // Load user lists into modal
            loadUserLists();
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('saveToListModal'));
            modal.show();
        }
        
        /**
         * Load user lists into modal
         */
        function loadUserLists() {
            const container = document.getElementById('userListsContainer');
            
            if (!userLists || userLists.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Bạn chưa có danh sách nào. Hãy tạo danh sách mới trước!
                    </div>
                    <a href="/vocabulary/lists/create" class="btn btn-primary w-100">
                        <i class="bi bi-plus-circle me-2"></i>Tạo danh sách mới
                    </a>
                `;
                document.getElementById('confirmSaveBtn').disabled = true;
                return;
            }
            
            let html = '';
            userLists.forEach(list => {
                html += `
                    <div class="form-check list-checkbox-item" onclick="toggleListCheckbox(${list.listId})">
                        <input class="form-check-input" type="checkbox" value="${list.listId}" 
                               id="list${list.listId}" onchange="updateSaveButton()">
                        <label class="form-check-label w-100" for="list${list.listId}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${list.name}</strong>
                                    <div class="text-muted small">${list.vocabCount || 0} từ</div>
                                </div>
                                ${list.isPublic ? '<span class="badge bg-success">Công khai</span>' : '<span class="badge bg-secondary">Riêng tư</span>'}
                            </div>
                        </label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('confirmSaveBtn').disabled = false;
        }
        
        /**
         * Toggle list checkbox
         */
        function toggleListCheckbox(listId) {
            const checkbox = document.getElementById(`list${listId}`);
            checkbox.checked = !checkbox.checked;
            updateSaveButton();
        }
        
        /**
         * Update save button state
         */
        function updateSaveButton() {
            const checkedBoxes = document.querySelectorAll('#userListsContainer input[type="checkbox"]:checked');
            document.getElementById('confirmSaveBtn').disabled = checkedBoxes.length === 0;
        }
        
        /**
         * Confirm save to list
         */
        async function confirmSaveToList() {
            const checkedBoxes = document.querySelectorAll('#userListsContainer input[type="checkbox"]:checked');
            
            if (checkedBoxes.length === 0) {
                alert('Vui lòng chọn ít nhất một danh sách!');
                return;
            }
            
            const listIds = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
            const vocabIds = Array.from(selectedVocabs.keys()).map(id => parseInt(id));
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            try {
                const response = await fetch('/api/vocab-lists/add-vocabs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify({
                        listIds: listIds,
                        vocabIds: vocabIds
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`Đã lưu ${vocabIds.length} từ vào ${listIds.length} danh sách thành công!`);
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('saveToListModal'));
                    modal.hide();
                    
                    // Reset checkboxes
                    checkedBoxes.forEach(cb => cb.checked = false);
                } else {
                    const error = await response.text();
                    alert('Có lỗi xảy ra: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi lưu từ vào danh sách. Vui lòng thử lại!');
            }
        }
        </script>
</body>
</html>
